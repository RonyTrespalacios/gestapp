<div class="chart-container" #chartContainer>
  <div class="chart-header">
    <h2>Flujo de Caja Mensual</h2>
    <p class="chart-subtitle">Últimos 12 meses</p>
  </div>

  <div class="chart-wrapper" *ngIf="monthlyData.length > 0">
    <svg 
      [attr.width]="chartWidth" 
      [attr.height]="chartHeight" 
      class="chart-svg"
      [style.max-width]="'100%'"
      [style.height]="'auto'"
      preserveAspectRatio="xMidYMid meet">

      <!-- Fondo del área de gráfico -->
      <rect
        [attr.x]="padding.left"
        [attr.y]="padding.top"
        [attr.width]="plotWidth"
        [attr.height]="plotHeight"
        fill="#fafafa"
        stroke="#000"
        stroke-width="2"
      />

      <!-- Grid lines horizontales -->
      <g class="grid-lines">
        <line
          *ngFor="let label of getYAxisLabels()"
          [attr.x1]="padding.left"
          [attr.y1]="label.y"
          [attr.x2]="padding.left + plotWidth"
          [attr.y2]="label.y"
          class="grid-line"
        />
      </g>

      <!-- Línea de cero -->
      <line
        *ngIf="minValue < 0 && maxValue > 0"
        [attr.x1]="padding.left"
        [attr.y1]="getYPosition(0)"
        [attr.x2]="padding.left + plotWidth"
        [attr.y2]="getYPosition(0)"
        class="zero-line"
        stroke-dasharray="5,5"
      />

      <!-- Barras -->
      <g class="bars">
        <g *ngFor="let bar of barsData" class="bar-group">
          <rect
            [attr.x]="bar.x"
            [attr.y]="bar.y"
            [attr.width]="bar.width"
            [attr.height]="bar.height"
            class="bar"
            [class.bar-positive]="bar.isPositive"
            [class.bar-negative]="!bar.isPositive"
          />
          
          <!-- Etiqueta del valor (hover) -->
          <g class="value-label">
            <rect
              [attr.x]="bar.centerX - 60"
              [attr.y]="bar.isPositive 
                ? bar.y - 45 
                : bar.y + bar.height + 5"
              width="120"
              height="38"
              class="label-bg"
              rx="2"
            />
            <text
              [attr.x]="bar.centerX"
              [attr.y]="bar.isPositive 
                ? bar.y - 28 
                : bar.y + bar.height + 22"
              class="label-text label-month"
              text-anchor="middle"
            >
              {{ bar.month }}
            </text>
            <text
              [attr.x]="bar.centerX"
              [attr.y]="bar.isPositive 
                ? bar.y - 15 
                : bar.y + bar.height + 35"
              class="label-text label-value"
              text-anchor="middle"
            >
              ${{ formatValue(bar.value) }}
            </text>
          </g>
        </g>
      </g>

      <!-- Etiquetas del eje Y (izquierda) -->
      <g class="y-axis">
        <text
          [attr.x]="padding.left - 20"
          [attr.y]="padding.top - 10"
          class="axis-title"
          text-anchor="middle"
        >
          Valor ($)
        </text>
        <g *ngFor="let label of getYAxisLabels()">
          <line
            [attr.x1]="padding.left - 5"
            [attr.y1]="label.y"
            [attr.x2]="padding.left"
            [attr.y2]="label.y"
            class="axis-tick"
          />
          <text
            [attr.x]="padding.left - 10"
            [attr.y]="label.y + 5"
            class="axis-label y-label"
            text-anchor="end"
            dominant-baseline="middle"
          >
            ${{ formatValue(label.value) }}
          </text>
        </g>
      </g>

      <!-- Etiquetas del eje X (abajo) -->
      <g class="x-axis">
        <text
          [attr.x]="padding.left + plotWidth / 2"
          [attr.y]="chartHeight - 10"
          class="axis-title"
          text-anchor="middle"
        >
          Mes
        </text>
        <g *ngFor="let bar of barsData">
          <line
            [attr.x1]="bar.centerX"
            [attr.y1]="padding.top + plotHeight"
            [attr.x2]="bar.centerX"
            [attr.y2]="padding.top + plotHeight + 5"
            class="axis-tick"
          />
          <text
            [attr.x]="bar.centerX"
            [attr.y]="padding.top + plotHeight + 25"
            class="axis-label x-label"
            text-anchor="middle"
            dominant-baseline="hanging"
          >
            {{ bar.month }}
          </text>
        </g>
      </g>
    </svg>
  </div>

  <div class="chart-empty" *ngIf="monthlyData.length === 0">
    <p>No hay datos suficientes para mostrar la gráfica</p>
  </div>
</div>

